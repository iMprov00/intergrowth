<style>
/* Кастомные стили оценки развития */
.physical-dev-assessment {
  font-size: 1.0rem;
  padding: 1.5rem;
  margin: 2rem 0;
  border-radius: 8px;
  text-align: center;
  font-weight: 00;
  line-height: 1.4;
  word-break: break-word;
  box-shadow: 0 2px 2px rgba(0,0,0,0.1);
}

/* Цветовые варианты */
.physical-dev-success {
  background-color: #28a745;
  color: white;
}

.physical-dev-warning {
  background-color: #ffc107;
  color: #212529;
}

.physical-dev-danger {
  background-color: #dc3545;
  color: white;
}

/* Стили для сообщения */
.physical-dev-alert {
  background-color: #f8d7da;
  color: #721c24;
  padding: 0.8rem;
  border-radius: 6px;
  font-size: 0.9rem;
  margin-top: 0.5rem;
}

/
</style>

<% @title = "Результаты оценки роста плода" %>
<div class="no-print">
<div class="row justify-content-center">
  <div class="col-lg-12">
    <div class="card shadow-sm mb-4 border-0">
      <div class="card-header bg-main text-white rounded-top d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><font color="white"><i class="bi bi-graph-up-arrow me-2"></i></font><font color="white">Результаты оценки роста плода</font></h4>
      </div>
      
      <div class="card-body">
        <!-- Сводные результаты -->
        <div class="row mb-4">
          <div class="col-md-4 mb-3">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Гестационный возраст</h5>
                <div class="display-5 fw-bold text-primary">
                  <font color="#54c654"><%= @measurement.gestational_weeks %>+<%= @measurement.gestational_days %> нед.</font>
                </div>
                <div class="mt-2">
                  <span class="badge" style="background-color: <%= @measurement.gender == 'M' ? '#0d6efd' : '#ff66b3' %>">
                    <%= @measurement.gender == 'M' ? 'Мужской' : 'Женский' %>
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title text-muted border-bottom pb-2">Параметры</h5>
                <div class="d-flex justify-content-between mb-2">
                  <span>Рост:</span>
                  <strong><%= @measurement.height %> см</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Вес:</span>
                  <strong><%= @measurement.weight %> кг</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Окружность головы:</span>
                  <strong><%= @measurement.head_circumference %> см</strong>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-4 mb-3">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Физическое развитие</h5>
                <% assessment = physical_development_assessment(@measurement.weight, @measurement.weight_percentile, @measurement.height_percentile) %>
                <div class="physical-dev-assessment physical-dev-<%= assessment[:alert] %>">
                  <%= assessment[:category].sub(/^\d+\.\s/, '') %>
                </div>
                <% if assessment[:message] %>
                  <div class="physical-dev-alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> <%= assessment[:message] %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div> <!-- Закрываем пропущенный div -->
        
        <!-- Графики роста -->
        <div class="row">
          <div class="col-12">
            <h5 class="mb-3"><i class="bi bi-bar-chart-line me-2"></i>Графики роста плода</h5>
          </div>
          
            <!-- График веса -->
            <div class="col-12 mb-4">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <span><font color="black">Вес плода (кг)</font></span>
                  <div>
                    <% if @measurement.weight_percentile >= 97 %>
                      <span class="badge bg-danger">Высокий</span>
                    <% elsif @measurement.weight_percentile >= 90 %>
                      <span class="badge bg-warning">Выше среднего</span>
                    <% elsif @measurement.weight_percentile >= 10 %>
                      <span class="badge bg-success">Средний</span>
                    <% elsif @measurement.weight_percentile >= 3 %>
                      <span class="badge bg-warning">Ниже среднего</span>
                    <% else %>
                      <span class="badge bg-danger">Низкий</span>
                    <% end %>
                  </div>
                </div>

                <div class="card-body">
                  <canvas id="weightChart" height="300"></canvas>
                </div>
              </div>
            </div>

            <!-- График роста -->
            <div class="col-12 mb-4">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <span><font color="black">Рост плода (см)</font></span>
                  <div>
                    <% if @measurement.height_percentile >= 97 %>
                      <span class="badge bg-danger">Высокий</span>
                    <% elsif @measurement.height_percentile >= 90 %>
                      <span class="badge bg-warning">Выше среднего</span>
                    <% elsif @measurement.height_percentile >= 10 %>
                      <span class="badge bg-success">Средний</span>
                    <% elsif @measurement.height_percentile >= 3 %>
                      <span class="badge bg-warning">Ниже среднего</span>
                    <% else %>
                      <span class="badge bg-danger">Низкий</span>
                    <% end %>
                  </div>
                </div>
                <div class="card-body">
                  <canvas id="heightChart" height="300"></canvas>
                </div>
              </div>
            </div>

            <!-- График окружности головы -->
            <div class="col-12 mb-4">
              <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                  <span><font color="black">Окружность головы (см)</font></span>
                  <div>
                    <% if @measurement.hc_percentile >= 97 %>
                      <span class="badge bg-danger">Высокий</span>
                    <% elsif @measurement.hc_percentile >= 90 %>
                      <span class="badge bg-warning">Выше среднего</span>
                    <% elsif @measurement.hc_percentile >= 10 %>
                      <span class="badge bg-success">Средний</span>
                    <% elsif @measurement.hc_percentile >= 3 %>
                      <span class="badge bg-warning">Ниже среднего</span>
                    <% else %>
                      <span class="badge bg-danger">Низкий</span>
                    <% end %>
                  </div>
                </div>
                <div class="card-body">
                  <canvas id="hcChart" height="300"></canvas>
                </div>
              </div>
            </div>
        </div> <!-- Закрываем row для графиков -->
        
        <div class="text-center mt-4">
          <button onclick="window.printReport()" class="btn btn-main me-2">
            <i class="bi bi-printer me-2"></i> Печать
          </button>
          <a href="/" class="btn btn-main">
            <i class="bi bi-arrow-left-circle me-2"></i> Новый расчет
          </a>
        </div>

      </div>
    </div>
  </div>
</div>
</div>
<script>
  // Функция для создания графика с учетом точного положения (недели + дни)
  const createPrecisionChart = (canvasId, chartData, title, unit) => {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Преобразуем данные для линейной шкалы
    const transformedData = {
      labels: chartData.labels,
      datasets: chartData.datasets.map(dataset => {
        if (dataset.label === "Ваш ребенок") {
          // Для пользовательской точки создаем специальный dataset
          return {
            ...dataset,
            data: [{ 
              x: chartData.exact_position, 
              y: dataset.data.find(v => v !== null) 
            }],
            pointRadius: 8,
            pointHoverRadius: 12
          };
        } else {
          // Для перцентильных кривых преобразуем данные
          return {
            ...dataset,
            data: dataset.data.map((y, index) => ({
              x: index,
              y: y
            }))
          };
        }
      })
    };

    // Специальные настройки для графика с учетом дней
    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += unit === 'кг' ? 
                  context.parsed.y.toFixed(2) + ' кг' : 
                  context.parsed.y.toFixed(1) + ' см';
              }
              return label;
            },
            title: function(context) {
              // Показываем точный гестационный возраст в подсказке
              const weeks = Math.floor(context[0].parsed.x);
              const days = Math.round((context[0].parsed.x % 1) * 7);
              return `${33 + weeks} нед. ${days} дн.`;
            }
          }
        },
        legend: {
          position: 'top',
          labels: {
            font: { size: 13 },
            usePointStyle: true,
            padding: 20,
            filter: function(item) {
              // Фильтруем дублирующиеся легенды
              return !item.text.includes('Ваш ребенок') || 
                     item.datasetIndex === chartData.datasets.length - 1;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          min: 0,
          max: 9,
          title: {
            display: true,
            text: 'Гестационный возраст (недели)',
            font: { size: 14, weight: 'bold' }
          },
          ticks: {
            stepSize: 1,
            callback: function(value) {
              return value % 1 === 0 ? (33 + value) + ' нед.' : '';
            }
          },
          grid: { display: false }
        },
        y: {
          title: {
            display: true,
            text: title + (unit ? ` (${unit})` : ''),
            font: { size: 14, weight: 'bold' }
          },
          min: function(context) {
            const min = Math.min(...context.chart.data.datasets
              .flatMap(d => d.data.map(v => v.y).filter(v => v !== null)));
            return unit === 'кг' ? Math.max(0, min * 0.9) : Math.max(30, min * 0.95);
          },
          max: function(context) {
            const max = Math.max(...context.chart.data.datasets
              .flatMap(d => d.data.map(v => v.y).filter(v => v !== null)));
            return unit === 'кг' ? max * 1.1 : max * 1.05;
          },
          grid: { color: 'rgba(0,0,0,0.05)' }
        }
      },
      elements: {
        point: {
          radius: function(context) {
            return context.dataset.label === 'Ваш ребенок' ? 8 : 0;
          },
          hoverRadius: function(context) {
            return context.dataset.label === 'Ваш ребенок' ? 12 : 6;
          }
        },
        line: {
          borderWidth: function(context) {
            return context.dataset.label === 'P50' ? 3 : 1;
          },
          tension: 0
        }
      }
    };

    return new Chart(ctx, {
      type: 'line',
      data: transformedData,
      options: options
    });
  };

  // Инициализация графиков с учетом дней
  document.addEventListener('DOMContentLoaded', function() {
    // График веса
    createPrecisionChart(
      'weightChart',
      <%= @weight_chart.to_json %>,
      'Вес плода', 
      'кг'
    );
    
    // График роста
    createPrecisionChart(
      'heightChart',
      <%= @height_chart.to_json %>,
      'Рост плода', 
      'см'
    );
    
    // График окружности головы
    createPrecisionChart(
      'hcChart',
      <%= @hc_chart.to_json %>,
      'Окружность головы', 
      'см'
    );
  });

function printReport() {
  // Создаем контейнер для печати
  const printSection = document.createElement('div');
  printSection.className = 'print-section';
  
  // Получаем данные из DOM
  const gestationalAge = document.querySelector('.display-5').textContent.trim();
  const gender = document.querySelector('.badge').textContent.trim();
  const height = document.querySelector('.card-body .d-flex:nth-child(1) strong').textContent.trim();
  const weight = document.querySelector('.card-body .d-flex:nth-child(2) strong').textContent.trim();
  const headCircumference = document.querySelector('.card-body .d-flex:nth-child(3) strong').textContent.trim();
  const assessment = document.querySelector('.physical-dev-assessment').textContent.trim();
  
  // Формируем компактный HTML для печати
  printSection.innerHTML = `
    <div class="print-header">
      <h2>Результаты оценки роста плода</h2>
      <div class="print-info-grid">
        <div class="print-info-item">
          <span class="print-info-label">Гестационный возраст:</span>
          <span class="print-info-value">${gestationalAge}</span>
        </div>
        <div class="print-info-item">
          <span class="print-info-label">Пол:</span>
          <span class="print-info-value">${gender}</span>
        </div>
        <div class="print-info-item">
          <span class="print-info-label">Рост:</span>
          <span class="print-info-value">${height}</span>
        </div>
        <div class="print-info-item">
          <span class="print-info-label">Вес:</span>
          <span class="print-info-value">${weight}</span>
        </div>
        <div class="print-info-item">
          <span class="print-info-label">Окружность головы:</span>
          <span class="print-info-value">${headCircumference}</span>
        </div>
        <div class="print-info-item">
          <span class="print-info-label">Оценка развития:</span>
          <span class="print-info-value">${assessment}</span>
        </div>
      </div>
    </div>
    
    <div class="print-charts">
      <div class="print-chart-container">
        <h4>Вес плода (кг)</h4>
        <canvas id="printWeightChart" class="print-chart"></canvas>
      </div>
      
      <div class="print-chart-container">
        <h4>Рост плода (см)</h4>
        <canvas id="printHeightChart" class="print-chart"></canvas>
      </div>
      
      <div class="print-chart-container">
        <h4>Окружность головы (см)</h4>
        <canvas id="printHcChart" class="print-chart"></canvas>
      </div>
    </div>
    
    <div class="print-signature">
      <div class="signature-line">Врач _____________ (подпись)</div>
    </div>
  `;
  
  // Добавляем стили для компактного отображения
  const style = document.createElement('style');
  style.textContent = `
    @media print {
      .print-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }
      .print-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .print-info-label {
        font-weight: bold;
        margin-right: 0.5rem;
      }
      .print-info-value {
        text-align: right;
      }
      .print-chart-container {
        page-break-inside: avoid;
        margin-bottom: 1rem;
      }
      .print-chart {
        width: 100% !important;
        height: 180px !important;
      }
    }
  `;
  printSection.appendChild(style);
  
  // Добавляем контейнер в документ
  document.body.appendChild(printSection);
  
  // Копируем графики
  setTimeout(() => {
    const weightChart = Chart.getChart('weightChart');
    const heightChart = Chart.getChart('heightChart');
    const hcChart = Chart.getChart('hcChart');
    
    // Опции для печатных графиков
    const printOptions = {
      responsive: false,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: { enabled: false }
      },
      scales: {
        x: { 
          ticks: { font: { size: 8 } },
          title: { font: { size: 9 } }
        },
        y: { 
          ticks: { font: { size: 8 } },
          title: { font: { size: 9 } }
        }
      }
    };
    
    // Создаем графики для печати
    if (weightChart) {
      new Chart(printSection.querySelector('#printWeightChart'), {
        type: 'line',
        data: JSON.parse(JSON.stringify(weightChart.data)),
        options: printOptions
      });
    }
    
    if (heightChart) {
      new Chart(printSection.querySelector('#printHeightChart'), {
        type: 'line',
        data: JSON.parse(JSON.stringify(heightChart.data)),
        options: printOptions
      });
    }
    
    if (hcChart) {
      new Chart(printSection.querySelector('#printHcChart'), {
        type: 'line',
        data: JSON.parse(JSON.stringify(hcChart.data)),
        options: printOptions
      });
    }
    
    // Даем время на отрисовку графиков
    setTimeout(() => {
      window.print();
      
      // Удаляем временный контейнер после печати
      setTimeout(() => {
        if (printSection.parentNode) {
          printSection.parentNode.removeChild(printSection);
        }
      }, 1000);
    }, 1000);
  }, 500);
}

window.printReport = printReport;
</script>
